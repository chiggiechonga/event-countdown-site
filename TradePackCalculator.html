<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trade Packs Calculator</title>
<style>
  body{box-sizing:border-box;font-family:Helvetica,Arial,sans-serif;margin:0;padding:20px;min-height:100vh;color:#e0e0e0;background-image:url('https://aa.cdn.gmru.net/ms/39fd61d35c175537444830cd8e3d31e5.jpg');background-repeat:no-repeat;background-attachment:fixed;background-size:cover;background-position:center center;background-color:rgba(0,0,0,0.25);background-blend-mode:multiply}
  .container{max-width:1400px;margin:0 auto}
  .info-box{background:rgba(0,0,0,0.85);padding:20px;margin-bottom:25px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.5);border:1px solid #333}
  .header{position:relative;text-align:center}
  .header h1{margin:0 0 10px 0;font-size:2.5rem;font-weight:700;color:#fff}
  .header-link{position:absolute;right:20px;top:50%;transform:translateY(-50%);color:#FDD835;text-decoration:none;font-size:16px;font-weight:500;padding:8px 16px;border:1px solid #FDD83540;border-radius:6px;background:rgba(253,216,53,0.1)}
  .header-link:hover{background:rgba(253,216,53,0.2);border-color:#FDD83580}
  .calculator-section{background:#252525;border-radius:12px;padding:25px;margin-bottom:25px;box-shadow:0 4px 20px rgba(0,0,0,0.4)}
  .section-header{font-size:18px;font-weight:600;color:#fff;margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid #546E7A}
  .input-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:20px}
  .input-group{display:flex;flex-direction:column;gap:8px}
  label{font-size:14px;font-weight:500;color:#b0b0b0}
  select,input{padding:10px;background:#1a1a1a;border:1px solid #444;border-radius:6px;color:#e0e0e0;font-size:14px}
  select:focus,input:focus{outline:none;border-color:#64B5F6}
  .checkbox-row{display:flex;gap:12px;align-items:center;margin-top:8px}
  .checkbox-group{display:flex;align-items:center;gap:6px}
  .checkbox-group label{font-size:14px;color:#e0e0e0;cursor:pointer}
  .checkbox-group input{width:18px;height:18px;cursor:pointer}
  .button-group{display:flex;gap:15px;margin-top:20px}
  .btn{padding:12px 24px;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s}
  .btn-primary{background:#64B5F6;color:#000}
  .btn-primary:hover{background:#42A5F5}
  .btn-secondary{background:#546E7A;color:#fff}
  .btn-success{background:#66bb6a;color:#000}
  .results-table{width:100%;border-collapse:collapse;margin-top:20px}
  .results-table th,.results-table td{padding:12px;text-align:left;border-bottom:1px solid #333;font-size:14px}
  .results-table th{background:#546E7A;color:#fff;font-weight:600;text-transform:uppercase;font-size:12px}
  .results-table tbody tr{background:#252525;transition:background .2s}
  .results-table tbody tr:hover{background:#2a2a2a}
  .ingredient-box{background:rgba(0,0,0,0.6);border:1px solid #444;border-radius:8px;padding:15px;margin-top:15px}
  .ingredient-box h3{color:#FDD835;margin-top:0;font-size:16px}
  @media (max-width:768px){.input-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="container">
    <div class="info-box">
      <div class="header">
        <h1>Trade Packs Calculator</h1>
        <a href="index.html" class="header-link">Event Schedules</a>
      </div>
    </div>

    <div class="calculator-section">
      <div class="section-header">Trade Routes</div>
      <div class="input-grid">
        <div class="input-group"><label for="fromSelect">From:</label><select id="fromSelect"><option value=""></option></select></div>
        <div class="input-group"><label for="packSelect">Pack:</label><select id="packSelect"><option value=""></option></select></div>
        <div class="input-group"><label for="toSelect">To:</label><select id="toSelect"><option value=""></option></select></div>
        <div class="input-group"><label for="demandInput">Demand (%):</label><input type="number" id="demandInput" value="130" min="0" step="1"></div>
      </div>

      <div class="checkbox-row">
        <div class="checkbox-group"><input type="checkbox" id="premiumCheck"><label for="premiumCheck">Premium</label></div>
        <div class="checkbox-group"><input type="checkbox" id="supplyOwnCheck"><label for="supplyOwnCheck">Own Materials</label></div>
        <div class="checkbox-group" id="warContainer" style="display:none;"><input type="checkbox" id="warCheck"><label for="warCheck">War? (+15% Ynystere)</label></div>
      </div>

      <div class="button-group">
        <button class="btn btn-primary" id="calcBtn">Calculate</button>
        <button class="btn btn-success" id="addBtn">Add Route</button>
        <button class="btn btn-secondary" id="clearBtn">Clear Routes</button>
      </div>

      <table class="results-table" id="resultsTable">
        <thead><tr><th>From</th><th>Pack</th><th>To</th><th>Demand</th><th>Total Profit</th><th>Labor</th><th>S/L</th></tr></thead>
        <tbody id="resultsBody"><tr><td colspan="7" style="text-align:center;color:#888">No routes calculated yet.</td></tr></tbody>
      </table>

      <div id="ingredientBox" class="ingredient-box" style="display:none"></div>
    </div>
  </div>

<script>
// Config
const PACKS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQHHKEyiE0qhz-s51VwX9-iblXZLgf5KQw2IhQxcpiM2FgjRaU2qPodYwpXIGixcEwQCWqw-rzqN2Zk/pub?gid=776663831&single=true&output=csv';
const INGREDIENTS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQHHKEyiE0qhz-s51VwX9-iblXZLgf5KQw2IhQxcpiM2FgjRaU2qPodYwpXIGixcEwQCWqw-rzqN2Zk/pub?gid=681613255&single=true&output=csv';
const RECIPES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQHHKEyiE0qhz-s51VwX9-iblXZLgf5KQw2IhQxcpiM2FgjRaU2qPodYwpXIGixcEwQCWqw-rzqN2Zk/pub?gid=1495951478&single=true&output=csv';

// Region orders you provided
const REGION_ORDER = {
  'Solis': ["Mahadevi","Falcorth","Tigerspine","Silent Forest","Villanelle","Savannah","Perinoor","Rookborne","Ynystere","Hasla","Arcum Iris","Solis","Rokhala","Sunbite Wilds"],
  'Villanelle': ["Solis","Arcum Iris","Mahadevi","Falcorth","Tigerspine","Silent Forest","Savannah","Perinoor","Rookborne","Ynystere","Hasla","Villanelle","Rokhala","Sunbite Wilds"],
  'Ynystere': ["Solis","Arcum Iris","Mahadevi","Falcorth","Tigerspine","Silent Forest","Villanelle","Savannah","Perinoor","Rookborne","Hasla","Ynystere","Rokhala","Sunbite Wilds"]
};

const ORIGINS = Array.from(new Set(Object.values(REGION_ORDER).flat())).sort((a,b)=>a.localeCompare(b));
const DESTINATIONS = ['Solis','Villanelle','Ynystere'];

// Data stores
let packData = []; // entries: { origin, packName, to, baseCopper }
let ingredientCosts = {}; // name -> silver (as float) e.g. 4.67 = 4s67c
let packRecipes = {}; // packName -> [{name, qty}, ...]
let comparisonResults = [];

// CSV parser (handles quoted values)
function parseCSV(text){
  const rows=[];
  let cur=[]; let token=''; let inQuotes=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(ch==='"'){ inQuotes=!inQuotes; continue; }
    if(ch===',' && !inQuotes){ cur.push(token.trim()); token=''; continue; }
    if((ch==='\n' || ch==='\r') && !inQuotes){ if(token!=='' || cur.length>0){ cur.push(token.trim()); rows.push(cur); } token=''; cur=[]; if(text[i+1]==='\n') i++; continue; }
    token+=ch;
  }
  if(token!=='' || cur.length>0){ cur.push(token.trim()); rows.push(cur); }
  return rows.map(r=>r.map(cell=>cell===undefined? '': cell));
}

function showError(msg){alert(msg);} // simple

// Map regions to their freshness quality
const REGION_FRESHNESS = {
  'Arcum Iris': 'Commercial',
  'Falcorth': 'Fine',
  'Hasla': 'Preserved',
  'Mahadevi': 'Fine',
  'Perinoor': 'Preserved',
  'Rokhala': 'Preserved',
  'Rookborne': 'Preserved',
  'Savannah': 'Preserved',
  'Silent Forest': 'Commercial',
  'Solis': 'Luxury',
  'Sunbite Wilds': 'Commercial',
  'Tigerspine': 'Fine',
  'Villanelle': 'Luxury',
  'Windscour': 'Preserved',
  'Ynystere': 'Commercial'
};

// Build packs using REGION_ORDER mapping and sheet layout you described
function buildPackDataFromSheet(rows){
  packData = [];
  // find header rows where A == 'Solis'/'Villanelle'/'Ynystere' (case-insensitive)
  for(const dest of Object.keys(REGION_ORDER)){
    let headerIndex = rows.findIndex(r=> (r[0]||'').toLowerCase() === dest.toLowerCase());
    if(headerIndex === -1) continue;
    // data rows start at headerIndex + 2 (skip blank/header row)
    const start = headerIndex + 2;
    const expected = REGION_ORDER[dest].length; // 14
    for(let i=0;i<expected;i++){
      const row = rows[start + i] || [];
      const origin = REGION_ORDER[dest][i];
      const freshness = REGION_FRESHNESS[origin] || '';
      // columns B..E are indices 1..4
      const types = ['Speciality','Gilda Specialty','Local Specialty','Fertilizer Specialty'];
      for(let c=1;c<=4;c++){
        const raw = (row[c]||'').trim();
        // allow empty values
        const gold = raw === '' ? 0 : parseFloat(raw.replace(/[^0-9.\-]/g,'')) || 0;
        // gold -> copper (1 gold = 10000 copper)
        const copper = Math.round(gold * 10000);
        const packName = `${origin} ${freshness} ${types[c-1]}`;
        // skip self-turnins (origin == dest)
        if(origin.toLowerCase() === dest.toLowerCase()) continue;
        packData.push({ origin, packName, to: dest, baseCopper: copper });
      }
    }
  }
}

function buildIngredientsFromSheet(rows){
  ingredientCosts = {};
  rows.forEach(r=>{
    const name = (r[0]||'').trim();
    if(!name) return;
    const raw = (r[1]||'').trim();
    if(raw === ''){ ingredientCosts[name] = 0; return; }
    // assume ingredient sheet values are in silver format (e.g., 4.67 for 4s67c)
    const val = parseFloat(raw.replace(/[^0-9.\-]/g,'')) || 0;
    ingredientCosts[name] = val; // silver float
  });
}

function buildRecipesFromSheet(rows){
  packRecipes = {};
  rows.forEach(r=>{
    const name = (r[0]||'').trim();
    if(!name) return;
    const list = [];
    for(let i=1;i<r.length;i+=2){
      const iname = (r[i]||'').trim();
      const qty = parseFloat((r[i+1]||'').trim()) || 0;
      if(iname) list.push({ name: iname, qty });
    }
    packRecipes[name] = list;
  });
}

function sortAndPopulateFrom(){
  const fromSel = document.getElementById('fromSelect');
  fromSel.innerHTML = '<option value=""></option>'; // blank default
  const origins = Array.from(new Set(packData.map(p=>p.origin))).sort((a,b)=>a.localeCompare(b));
  origins.forEach(o=> fromSel.add(new Option(o,o)));
}

function updatePackDropdown(){
  const origin = document.getElementById('fromSelect').value;
  const packSel = document.getElementById('packSelect');
  packSel.innerHTML = '<option value=""></option>';
  if(!origin) return;
  const names = Array.from(new Set(packData.filter(p=>p.origin===origin).map(p=>p.packName))).sort((a,b)=>a.localeCompare(b));
  names.forEach(n=> packSel.add(new Option(n,n)));
}

function updateWarCheckbox(){
  const to = document.getElementById('toSelect').value;
  const warContainer = document.getElementById('warContainer');
  if(to === 'Ynystere') warContainer.style.display = 'flex'; else { warContainer.style.display = 'none'; document.getElementById('warCheck').checked = false; }
}

function getFreshnessBonus(packName) {
  const name = packName.toLowerCase();
  if (name.includes("luxury")) return 1.30;
  if (name.includes("fine")) return 1.15;
  if (name.includes("commercial")) return 1.05;
  if (name.includes("preserved")) return 1.03;
  return 1.00;
}

function copperToGSC(copper){
  const neg = copper < 0; if(neg) copper = Math.abs(copper);
  const g = Math.floor(copper / 10000);
  const s = Math.floor((copper % 10000) / 100);
  const c = Math.floor(copper % 100);
  return (neg?'-':'') + `${g}g ${s}s ${c}c`;
}

function calculatePack(showDetails){
  const origin = document.getElementById('fromSelect').value;
  const packName = document.getElementById('packSelect').value;
  const to = document.getElementById('toSelect').value;
  const demandPct = parseFloat(document.getElementById('demandInput').value) || 130;
  const premium = document.getElementById('premiumCheck').checked;
  const own = document.getElementById('supplyOwnCheck').checked;
  const war = document.getElementById('warCheck') ? document.getElementById('warCheck').checked : false;

  if(!origin || !packName || !to){ if(showDetails) showError('Please select From, Pack and To'); return null; }

  const entry = packData.find(p=>p.origin===origin && p.packName===packName && p.to===to);
  if(!entry){ if(showDetails) showError('No pack data for that route'); return null; }

  // DEBUG: Log the values
  console.log('Pack:', packName);
  console.log('Base Copper:', entry.baseCopper);
  console.log('Demand:', demandPct);
  
  // base copper value from sheet
  let baseCopper = entry.baseCopper; // copper
  
  // Check if baseCopper is 0
  if(baseCopper === 0){
    if(showDetails) showError('No base value found for this pack route in the spreadsheet');
    return null;
  }
  
 * demand * freshnessBonus;
  if(premium) valueGold *= 1.05;
  if(war && to === 'Ynystere') valueGold *= 1.15;
  const turnInCopper = Math.round(valueGold * 10000);
  
  console.log('Freshness Bonus:', freshnessBonus);
  console.log('Turn-in Copper:', turnInCopper);

  // ingredient cost
  let ingredientCopper = 0;
  const recipe = packRecipes[packName] || [];
  if(!own){
    recipe.forEach(i=>{
      const costSilver = ingredientCosts[i.name] || 0; // silver float
      const costCopperPerUnit = Math.round(costSilver * 100);
      ingredientCopper += costCopperPerUnit * i.qty;
    });
  }

  // crafting cost (silver) - simple fixed 50s unless own materials
  const craftingSilver = own ? 0 : 50;
  const craftingCopper = craftingSilver * 100;

  const profitCopper = turnInCopper - ingredientCopper - craftingCopper;
  const labor = 125; // simplified
  const sPerL = profitCopper / labor;

  const result = { origin, packName, to, demand: (demandPct)+'%', profitCopper, labor, sPerL, recipe, ingredientCopper };
  if(showDetails) displaySingleResult(result);
  return result;
}

function displaySingleResult(r){
  const tbody = document.getElementById('resultsBody');
  tbody.innerHTML = '';
  const tr = document.createElement('tr');
  tr.innerHTML = `<td>${r.origin}</td><td>${r.packName}</td><td>${r.to}</td><td>${r.demand}</td><td>${copperToGSC(r.profitCopper)}</td><td>${r.labor}</td><td><strong>${(r.sPerL/100).toFixed(2)} s/l</strong></td>`;
  tbody.appendChild(tr);
  showIngredientBox(r);
}

function showIngredientBox(r){
  const box = document.getElementById('ingredientBox');
  if(!r.recipe || r.recipe.length===0){ box.style.display='none'; return; }
  let total = 0; let html = `<h3>Ingredients for ${r.packName}</h3><ul>`;
  r.recipe.forEach(i=>{
    const costSilver = ingredientCosts[i.name] || 0;
    const costCopperPerUnit = Math.round(costSilver * 100);
    const subtotal = costCopperPerUnit * i.qty;
    total += subtotal;
    html += `<li>${i.qty} x ${i.name} @ ${copperToGSC(costCopperPerUnit)} = ${copperToGSC(subtotal)}</li>`;
  });
  html += `</ul><strong>Total Ingredient Cost: ${copperToGSC(total)}</strong>`;
  box.innerHTML = html; box.style.display = 'block';
}

function addRoute(){
  const r = calculatePack(false);
  if(!r) return;
  comparisonResults.push(r);
  updateComparisonTable();
}

function updateComparisonTable(){
  const tbody = document.getElementById('resultsBody');
  tbody.innerHTML = '';
  comparisonResults.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.origin}</td><td>${r.packName}</td><td>${r.to}</td><td>${r.demand}</td><td>${copperToGSC(r.profitCopper)}</td><td>${r.labor}</td><td><strong>${(r.sPerL/100).toFixed(2)} s/l</strong></td>`;
    tbody.appendChild(tr);
  });
  if(comparisonResults.length>0){ showIngredientBox(comparisonResults[comparisonResults.length-1]); }
}

function clearRoutes(){ comparisonResults=[]; updateComparisonTable(); document.getElementById('ingredientBox').style.display='none'; }

// attach UI event listeners immediately so buttons work even if fetch fails
try{
  document.getElementById('fromSelect').addEventListener('change', updatePackDropdown);
  document.getElementById('toSelect').addEventListener('change', updateWarCheckbox);
  document.getElementById('calcBtn').addEventListener('click', ()=>{ const res = calculatePack(true); if(!res) {/* silent */} });
  document.getElementById('addBtn').addEventListener('click', ()=>{ if(packData.length===0){ showError('Data not loaded yet. Please wait or host the page'); return; } addRoute(); });
  document.getElementById('clearBtn').addEventListener('click', clearRoutes);
}catch(e){ /* elements may not exist yet in rare cases; will attach in init as fallback */ }

// Initialization: fetch sheets and build data
async function fetchText(url){ const res = await fetch(url); if(!res.ok) throw new Error('HTTP '+res.status); return await res.text(); }
async function init(){
  try{
    const [pText, iText, rText] = await Promise.all([fetchText(PACKS_URL), fetchText(INGREDIENTS_URL), fetchText(RECIPES_URL)]);
    const pRows = parseCSV(pText);
    const iRows = parseCSV(iText);
    const rRows = parseCSV(rText);
    buildPackDataFromSheet(pRows);
    buildIngredientsFromSheet(iRows);
    buildRecipesFromSheet(rRows);
    sortAndPopulateFrom();
    // populate To dropdown blank + options
    const toSel = document.getElementById('toSelect'); toSel.innerHTML = '<option value=""></option>'; DESTINATIONS.forEach(d=> toSel.add(new Option(d,d)));
    // wire events in case previous attach failed
    try{
      document.getElementById('fromSelect').addEventListener('change', updatePackDropdown);
      document.getElementById('toSelect').addEventListener('change', updateWarCheckbox);
      document.getElementById('calcBtn').addEventListener('click', ()=>calculatePack(true));
      document.getElementById('addBtn').addEventListener('click', addRoute);
      document.getElementById('clearBtn').addEventListener('click', clearRoutes);
    }catch(e){console.warn('Could not attach event listeners in init', e)}
  }catch(err){ console.error(err); showError('Failed to load sheet data. If opening locally use a server or host on GitHub Pages.'); }
}

init();
</script>
</body>
</html>
